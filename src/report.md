# Cети в Linux.
### Настройка сетей в Linux на виртуальных машинах.
## Part 1. Инструмент ipcalc
### 1.1. Сети и маски
 Определи и запиши в отчёт:
 - Адрес сети 192.167.38.54/13
 - Перевод маски 255.255.255.0 в префиксную и двоичную запись, /15 в обычную и двоичную, 11111111.11111111.11111111.11110000 в обычную и префиксную
 - Минимальный и максимальный хост в сети 12.167.38.4 при масках: /8, 11111111.11111111.00000000.00000000, 255.255.254.0 и /4
### 1.2. localhost
 - Определи и запиши в отчёт, можно ли обратиться к приложению, работающему на localhost, со следующими IP: 194.34.23.100, 127.0.0.2, 127.1.0.1, 128.0.0.1
### 1.3. Диапазоны и сегменты сетей
 Определи и запиши в отчёт:
 - Какие из перечисленных IP можно использовать в качестве публичного, а какие только в качестве частных: 10.0.0.45, 134.43.0.2, 192.168.4.2, 172.20.250.4, 172.0.2.1, 192.172.0.1, 172.68.0.2, 172.16.255.255, 10.10.10.10, 192.169.168.1
 - Какие из перечисленных IP адресов шлюза возможны у сети 10.10.0.0/18: 10.0.0.1, 10.10.0.2, 10.10.10.10, 10.10.100.1, 10.10.1.255
## Выполнение Part 1
### Адрес сети 192.167.38.54/13 утилитой ipcalc:
![alt text](<pictures/Picture 1.jpg>)
### Перевод маски 255.255.255.0 в утилите ipcalc:
![alt text](<pictures/Picture 2.jpg>)
### Перевод маски /15 в утилите ipcalc:
![alt text](<pictures/Picture 3.jpg>)
### Перевод маски 11111111.11111111.11111111.11110000
 Десятичная: 255. 255. 255. 240 
 
 Префиксная: /28

### Min/Max хост в сети 12.167.38.4 при разных масках:
![alt text](<pictures/Picture 4.jpg>)
![alt text](<pictures/Picture 5.jpg>)
### Подключение к localhost (127.0.0.1/8)
  Loopback - адреса 127.0.0.0/8. Туда входят диапазон адресов 127.0.0.0 - 127.255.255.255.

Адреса 127.0.0.2, 127.1.0.1 являются частью loopback, поэтому если приложение
запущено на localhost == 127.0.0.1, то мы сможем подключиться к этим адресам тк они
являются частью loopback.
На адреса 194.34.23.100, 128.0.0.1 мы не сможем подкючиться тк они вне контура
loopback
### Публичные и частные ip-адреса
Публичный адрес используется для выхода в интернет, а частный — для обмена данными в локальных сетях.

Все публичные адреса распределены между региональными интернет-регистраторами. Их всего пять: 

RIPE — для Европы и Ближнего Востока, 

ARIN — для Северной Америки, 

APNIC — для Азии и стран Тихого океана, 

LANIC — для Латинской Америки, 

AfriNIC — для Африки.

![alt text](<pictures/Picture 7.jpg>)

- 10.0.0.45 - private

- 134.43.0.2 - public

- 192.168.4.2 - private

- 172.20.250.4 - private

- 172.0.2.1 - public

- 192.172.0.1 - public

- 172.68.0.2 - public

- 172.16.255.255 - private

- 10.10.10.10 - private

- 192.169.168.1 - public

### Шлюза у сети 10.10.0.0/18
Маска /18 = 11111111.11111111.11000000.00000000

![alt text](<pictures/Picture 6.jpg>)

10.0.0.1 - в радиусе сети 

10.10.0.2 - в радиусе сети

10.10.10.10 - в радиусе сети

10.10.100.1 - не в радиусе сети

10.10.1.255 - в радиусе сети

## Part 2. Статическая маршрутизация между двумя машинами

 Подними две виртуальные машины (далее -- ws1 и ws2).

 С помощью команды ip a посмотри существующие сетевые интерфейсы.

  В отчёт помести скрин с вызовом и выводом использованной команды.

 Опиши сетевой интерфейс, соответствующий внутренней сети, на обеих машинах и задать следующие адреса и маски: ws1 - 192.168.100.10, маска /16, ws2 - 172.24.116.8, маска /12.

 В отчёт помести скрины с содержанием изменённого файла etc/netplan/00-installer-config.yaml для каждой машины.


 Выполни команду netplan apply для перезапуска сервиса сети.

 В отчёт помести скрин с вызовом и выводом использованной команды.


### 2.1. Добавление статического маршрута вручную

 Добавь статический маршрут от одной машины до другой и обратно при помощи команды вида ip r add.

 Пропингуй соединение между машинами.

 В отчёт помести скрин с вызовом и выводом использованных команд.


### 2.2. Добавление статического маршрута с сохранением

 Перезапусти машины.

 Добавь статический маршрут от одной машины до другой с помощью файла etc/netplan/00-installer-config.yaml.

 В отчёт помести скрин с содержанием изменённого файла etc/netplan/00-installer-config.yaml.

 Пропингуй соединение между машинами.

 В отчёт помести скрин с вызовом и выводом использованной команды.

## Выполнение Part 2

### Сетевые интерфейсы (ip a) двух машин:

ws1:
![alt text](<pictures/Picture 10.jpg>)

ws2:
![alt text](<pictures/Picture 11.jpg>)

### Добавление нового адаптера в отделе "Сети"

Адаптер будет именно внутренней сети и под одним названием

ws1:
![alt text](<pictures/Picture 8.jpg>)

ws2:
![alt text](<pictures/Picture 9.jpg>)

### Задаем параметры нашего сетевого адаптера enp0s8

ws1:
![alt text](<pictures/Picture 12.jpg>)

ws2:
![alt text](<pictures/Picture 13.jpg>)

### Прописываем команду `sudo netplan apply` для обновления enp0s8 и `ip a`

ws1:
![alt text](<pictures/Picture 14.jpg>)

ws2:
![alt text](<pictures/Picture 15.jpg>)

### Добавление статического маршрута вручную

ws1:
![alt text](<pictures/Picture 16.jpg>)

ws2:
![alt text](<pictures/Picture 17.jpg>)

### Проверим ping между ними

ws1:
![alt text](<pictures/Picture 18.jpg>)

ws2:
![alt text](<pictures/Picture 19.jpg>)

Однако после `reboot` данный route не сохраняется, поэтому пропишем его в etc/netplan/00-installer-config.yaml

ws1:
![alt text](<pictures/Picture 20.jpg>)

ws2:
![alt text](<pictures/Picture 21.jpg>)

### Проверим ping между ними

ws1:
![alt text](<pictures/Picture 22.jpg>)

ws2:
![alt text](<pictures/Picture 23.jpg>)

## Part 3. Утилита iperf3

### 3.1. Скорость соединения

 Переведи и запиши в отчёт: 8 Mbps в MB/s, 100 MB/s в Kbps, 1 Gbps в Mbps.

### 3.2. Утилита iperf3

Измерь скорость соединения между ws1 и ws2.

В отчёт помести скрины с вызовом и выводом использованных команд.

## Выполнение Part 3

Утилита iperf - это генератор сетевого трафика, предназначенный для проверки скорости и пропускной способности сети.

Перевод 8 Mbps в MB/s, 100 MB/s в Kbps, 1 Gbps в Mbps:

8 Mbps = 1 MB/s
100 MB/s = 800000 Kbps
1 Gbps = 1000 Mbps

Проверка соединения, где ws1 - сервер, а ws2 - "клиент"

ws1:
![alt text](<pictures/Picture 24.jpg>)

ws2:
![alt text](<pictures/Picture 25.jpg>)

Проверка соединения, где ws2 - сервер, а ws1 - "клиент"

ws1:
![alt text](<pictures/Picture 26.jpg>)

ws2:
![alt text](<pictures/Picture 27.jpg>)

## Part 4. Сетевой экран

### 4.1. Утилита iptables

 - Создай файл /etc/firewall.sh, имитирующий фаерволл, на ws1 и ws2:


Нужно добавить в файл подряд следующие правила:

1) На ws1 примени стратегию, когда в начале пишется запрещающее правило, а в конце пишется разрешающее правило (это касается пунктов 4 и 5).

2) На ws2 примени стратегию, когда в начале пишется разрешающее правило, а в конце пишется запрещающее правило (это касается пунктов 4 и 5).

3) Открой на машинах доступ для порта 22 (ssh) и порта 80 (http).

4) Запрети echo reply (машина не должна «пинговаться», т.е. должна быть блокировка на OUTPUT).

5) Разреши echo reply (машина должна «пинговаться»).

Запусти файлы на обеих машинах командами chmod +x /etc/firewall.sh и /etc/firewall.sh.

В отчёт помести скрины с запуском обоих файлов;
В отчёте опиши разницу между стратегиями, применёнными в первом и втором файлах.

### 4.2. Утилита nmap

Командой ping найди машину, которая не «пингуется», после чего утилитой nmap покажи, что хост машины запущен.
Проверка: в выводе nmap должно быть сказано: Host is up.

В отчёт помести скрины с вызовом и выводом использованных команд ping и nmap.

## Выполнение Part 4

Полезные ссылки на iptables:
1) https://www.k-max.name/linux/netfilter-iptables-v-linux/
2) https://www.opennet.ru/cgi-bin/opennet/man.cgi?topic=iptables&category=8
3) https://bozza.ru/art-233.html

### Создание файла etc/firewall.sh на двух машинах:

ws1:
![alt text](<pictures/Picture 28.jpg>)

ws2:
![alt text](<pictures/Picture 29.jpg>)

В данном файле прописаны все правила, я разрешил доступ на два порта, а также написал правила на двух машинах согласно условиям.
Запуск файла firewall.sh на двух машинах:

ws1 и ws2:

![alt text](<pictures/Picture 34.jpg>)

### Теперь посмотрим набор правил в iptables после sudo sh firewall.sh (запуска firewall)

ws1:
![alt text](<pictures/Picture 30.jpg>)

ws2:
![alt text](<pictures/Picture 31.jpg>)

В ws1 правило DROP с echo-reply стоит по приоритету выше, чем echo-reply ACCEPT, поэтому, когда мы будем делать до него ping, он возвращать ничего не будет

ws2:
![alt text](<pictures/Picture 32.jpg>)

А в ws2 ситуация аналогично обратная, echo-reply с ACCEPT стоит приоритетнее, поэтому ответы от него будут приходить и ping будет работать:

ws1:
![alt text](<pictures/Picture 33.jpg>)

### Решение 4.2. nmap:

Увидим на ping с одной машины на другую с запущенными firewall.sh

ws1:
![alt text](<pictures/Picture 32.jpg>)

ws2:
![alt text](<pictures/Picture 33.jpg>)

И теперь посмотрим состояние хостов с помощью nmap:

ws1:
![alt text](<pictures/Picture 35.jpg>)

ws2:
![alt text](<pictures/Picture 36.jpg>)

Видими, что хосты запущены, но ping все равно не доходит до одной машины - и причина этому DROP icmp echo-reply.

## Part 5. Статическая маршрутизация сети

![alt text](<pictures/Part 5.png>)

Подними пять виртуальных машин (3 рабочие станции (ws11, ws21, ws22) и 2 роутера (r1, r2))

### 5.1. Настройка адресов машин

1) Настрой конфигурации машин в etc/netplan/00-installer-config.yaml согласно сети на рисунке.

2) Перезапусти сервис сети. Если ошибок нет, то командой ip -4 a проверь, что адрес машины задан верно. Также пропингуй ws22 с ws21. Аналогично пропингуй r1 с ws11.

### 5.2. Включение переадресации IP-адресов

Для включения переадресации IP, выполни команду на роутерах: `sysctl -w net.ipv4.ip_forward=1`

При таком подходе переадресация не будет работать после перезагрузки системы.

Открой файл /etc/sysctl.conf и добавь в него следующую строку: `net.ipv4.ip_forward = 1`

При использовании этого подхода, IP-переадресация включена на постоянной основе.

### 5.3. Установка маршрута по-умолчанию

Пример вывода команды ip r после добавления шлюза:

`default via 10.10.0.1 dev eth0`

`10.10.0.0/18 dev eth0 proto kernel scope link src 10.10.0.2`

1) Настрой маршрут по-умолчанию (шлюз) для рабочих станций. Для этого добавь default перед IP роутера в файле конфигураций.

2) Вызови ip r и покажи, что добавился маршрут в таблицу маршрутизации.

3) Пропингуй с ws11 роутер r2 и покажи на r2, что пинг доходит. Для этого используй команду:
tcpdump -tn -i eth0

### 5.4. Добавление статических маршрутов

Добавь в роутеры r1 и r2 статические маршруты в файле конфигураций. Пример для r1 маршрута в сетку 10.20.0.0/26:

Добавь в конец описания сетевого интерфейса eth1:
```
- to: 10.20.0.0
  via: 10.100.0.12
```
Вызови ip r и покажи таблицы с маршрутами на обоих роутерах. Пример таблицы на r1:
```
10.100.0.0/16 dev eth1 proto kernel scope link src 10.100.0.11
10.20.0.0/26 via 10.100.0.12 dev eth1
10.10.0.0/18 dev eth0 proto kernel scope link src 10.10.0.1
```
Запусти команды на ws11:
`ip r list 10.10.0.0/[маска сети]` и `ip r list 0.0.0.0/0`

### 5.5. Построение списка маршрутизаторов

Пример вывода утилиты traceroute после добавления шлюза:
```
1 10.10.0.1 0 ms 1 ms 0 ms
2 10.100.0.12 1 ms 0 ms 1 ms
3 10.20.0.10 12 ms 1 ms 3 ms
```

Запусти на r1 команду дампа:

`tcpdump -tnv -i eth0`

При помощи утилиты traceroute построй список маршрутизаторов на пути от ws11 до ws21.

### 5.6. Использование протокола ICMP при маршрутизации

Запусти на r1 перехват сетевого трафика, проходящего через eth0 с помощью команды:

`tcpdump -n -i eth0 icmp`

Пропингуй с ws11 несуществующий IP (например, 10.30.0.111) с помощью команды:

`ping -c 1 10.30.0.111`

## Выполнение Part 5

Создаем наши 5 машин (я сделал полное клонирование):

![alt text](<pictures/Picture 37.jpg>)

Далее нужно сделать настройку конфига (адаптеры внутренней сети, согласно картинке):

ws11:
![alt text](<pictures/Picture 38.jpg>)

r1 (1 адаптер):
![alt text](<pictures/Picture 39.jpg>)

r1 (2 адаптер): 
![alt text](<pictures/Picture 42.jpg>)

r2 (1 адаптер):
![alt text](<pictures/Picture 40.jpg>)

r2 (2 адаптер): 
![alt text](<pictures/Picture 41.jpg>)

ws21:
![alt text](<pictures/Picture 43.jpg>)

ws22:
![alt text](<pictures/Picture 44.jpg>)

И также пропишем наш конфиг в etc/netplan/00-installer-config.yaml согласно рисунку:

ws11:
![alt text](<pictures/Picture 45.jpg>)

r1:
![alt text](<pictures/Picture 46.jpg>)

r2: 
![alt text](<pictures/Picture 47.jpg>)

ws22:
![alt text](<pictures/Picture 49.jpg>)

w21: 
![alt text](<pictures/Picture 48.jpg>)

Пропишем `sudo netplan apply` на каждой машине и проверим ip у машин с помощью `ip -4 a`:

ws11:
![alt text](<pictures/Picture 50.jpg>)

r1:
![alt text](<pictures/Picture 51.jpg>)

r2: 
![alt text](<pictures/Picture 52.jpg>)

ws22:
![alt text](<pictures/Picture 54.jpg>)

w21: 
![alt text](<pictures/Picture 53.jpg>)

Ping ws22 с ws21:
![alt text](<pictures/Picture 55.jpg>)

Ping r1 с ws11:
![alt text](<pictures/Picture 56.jpg>)

### 5.2. Включение переадресации IP-адресов

ip forward нужен для маршрутизации пакетов с одного сетевого интерфейса на другой (то есть, выполнять основную функцию роутера, по сути)
Для начала попробуем ввести `sysctl -w net.ipv4.ip_forward=1`

r1:
![alt text](<pictures/Picture 57.jpg>)

r2:
![alt text](<pictures/Picture 59.jpg>)

После перезагрузки ip_forward снова станет 0. Поэтому вручную прописываем в config-файле:

r1:
![alt text](<pictures/Picture 58.jpg>)

r2:
![alt text](<pictures/Picture 60.jpg>)

### 5.3. Установка маршрута по-умолчанию

```
routes: — объявляем блок описания маршрутов.
  — to: — задаем адрес/подсеть до которой необходим маршрут.
    via: — указываем шлюз через которой будет доступна наша подсеть.
```
ws11:
![alt text](<pictures/Picture 61.jpg>)

ws22:
![alt text](<pictures/Picture 62.jpg>)

ws21:
![alt text](<pictures/Picture 63.jpg>)

Проверим командой ip r маршруты:

ws11:
![alt text](<pictures/Picture 64.jpg>)

ws22:
![alt text](<pictures/Picture 66.jpg>)

ws21:
![alt text](<pictures/Picture 65.jpg>)

Попробуем пропинговаться до r2 с ws11:

ws11:
![alt text](<pictures/Picture 68.jpg>)

r2:
![alt text](<pictures/Picture 67.jpg>)

echo-request до r2 доходит, но у r2 еще не настроены маршруты для echo-reply. Пинг по итогу удался

### 5.4. Добавление статических маршрутов

Добавление в config r1, r2 routes:

r1:
![alt text](<pictures/Picture 69.jpg>)

r2:
![alt text](<pictures/Picture 70.jpg>)

`ip r` у r1, r2 после обновления config'a:

r1:
![alt text](<pictures/Picture 71.jpg>)

r2:
![alt text](<pictures/Picture 72.jpg>)

Команды ```ip r list 10.10.0.0/[маска сети]``` и ```ip r list 0.0.0.0/0``` на ws11:
![alt text](<pictures/Picture 73.jpg>)

ip r list 0.0.0.0/0 , утилита ip отображает маршруты по умолчанию. Этот маршрут
используется для пересылки пакетов, если их целевой адрес не соответствует ни одному
из более специфичных маршрутов в таблице.

ip r list 10.10.0.0/18 , утилита ip отображает маршруты, которые охватывают сеть
10.10.0.0/18 . Эта команда покажет маршруты, которые включают или пересекаются с
указанной сетью.

Маршрут по умолчанию служит запасным вариантом для пунктов назначения, не
охваченных другими маршрутами. Поэтому в данном сценарии трафик, предназначенный
для сети 10.10.0.0/[netmask] , всегда будет использовать конкретный маршрут
10.10.0.0/18 , минуя маршрут по умолчанию, чтобы обеспечить точную маршрутизацию
в этом сегменте сети

### 5.5. Построение списка маршрутизаторов

traceroute с ws11 до ws21:

![alt text](<pictures/Picture 74.jpg>)

Запуск команды `tcpdump -tnv -i eth0` на r1:

![alt text](<pictures/Picture 75.jpg>)

Объяснение traceroute у ws11:
```
Traceroute работает, отправляя пакеты с постепенно увеличивающимися значениями
Time-To-Live (TTL) и анализируя ответы ICMP (Internet Control Message Protocol) от
промежуточных маршрутизаторов.

1. Инициализация:
Traceroute начинает отправку пакетов с TTL, установленным в 1.
Значение TTL включено в заголовок IP и уменьшается каждым
маршрутизатором, через который проходит пакет.

2. Истечение срока TTL и ICMP Time Exceeded:
Когда значение TTL достигает 0, маршрутизатор отбрасывает пакет и
отправляет сообщение ICMP Time Exceeded обратно к источнику.
Traceroute записывает IP-адрес маршрутизатора из сообщения ICMP.

3. Увеличение TTL:
Traceroute затем отправляет следующий пакет с TTL, установленным в 2. Этот
пакет достигнет второго маршрутизатора в пути до истечения TTL, и процесс
повторяется.
Это продолжается, при каждом новом отправлении TTL увеличивается на 1, что
позволяет traceroute обнаруживать каждый хоп на пути к назначению.

4. Достижение назначения:
Процесс продолжается до тех пор, пока пакет не достигнет назначения. Когда
это происходит, обычно отправляется ICMP Echo Reply (для ICMP-based
traceroute) или TCP/UDP пакет (для других вариантов).

5. Запись пути:
Traceroute записывает IP-адрес, время кругового путешествия (RTT) и любую
потерю пакетов для каждого хопа.
 ```

### 5.6. Использование протокола ICMP при маршрутизации

ping несуществующего ip с ws11:

![alt text](<pictures/Picture 76.jpg>)

Прослушка с r1 с помощью `tcpdump -tnv -i eth0`:

![alt text](<pictures/Picture 77.jpg>)

## Part 6. Динамическая настройка IP с помощью DHCP

Для r2 настрой в файле /etc/dhcp/dhcpd.conf конфигурацию службы DHCP:

1) Укажи адрес маршрутизатора по-умолчанию, DNS-сервер и адрес внутренней сети. 

Пример файла для r2:

```
subnet 10.100.0.0 netmask 255.255.0.0 {}

subnet 10.20.0.0 netmask 255.255.255.192
{
    range 10.20.0.2 10.20.0.50;
    option routers 10.20.0.1;
    option domain-name-servers 10.20.0.1;
}
```

2) В файле resolv.conf пропиши nameserver 8.8.8.8.

Перезагрузи службу DHCP командой systemctl restart isc-dhcp-server. Машину ws21 перезагрузи при помощи reboot и через ip a покажи, что она получила адрес. Также пропингуй ws22 с ws21.

Укажи MAC адрес у ws11, для этого в etc/netplan/00-installer-config.yaml надо добавить строки: `macaddress: 10:10:10:10:10:BA`, `dhcp4: true`

Для r1 настрой аналогично r2, но сделай выдачу адресов с жесткой привязкой к MAC-адресу (ws11). Проведи аналогичные тесты.

Запроси с ws21 обновление ip адреса.

## Выполнение Part 6

Для начала настраиваем в r2 в /etc/dhcp/dhcpd.conf конфигурацию службы DHCP:

![alt text](<pictures/Picture 80.jpg>)

В файле resolf.conf прописываем nameserver (Опция nameserver указывает на IP адрес DNS сервера.):

![alt text](<pictures/Picture 79.jpg>)

![alt text](<pictures/Picture 81.jpg>)

Посмотрим теперь на ws21 после reboot:

![alt text](<pictures/Picture 82.jpg>)

![alt text](<pictures/Picture 83.jpg>)

ip адрес изменился согласно нашим настройкам dhcp в r2

ping ws22 с ws21:

![alt text](<pictures/Picture 84.jpg>)

Указываем MAC адрес у ws11 (в netplan config и в настройке сети)

![alt text](<pictures/Picture 87.jpg>)

![alt text](<pictures/Picture 86.jpg>)

Делаем настройку dhcp у r1 для сети eth1 и делаем генерацию ip с жесткой привязкой к MAC-адресу ws11

![alt text](<pictures/Picture 85.jpg>)

reboot ws11 и получение нового ip адреса:

![alt text](<pictures/Picture 88.jpg>)

Обновление ip-адреса у ws21:

![alt text](<pictures/Picture 89.jpg>)

![alt text](<pictures/Picture 90.jpg>)

Команда dhclient используется для управления клиентом DHCP на системе. Команды,
которые вы указали, выполняют следующие действия:

`sudo dhclient enp0s8 -r`
Эта команда отправляет запрос на освобождение текущего IP-адреса, который был
получен через DHCP для интерфейса enp0s8 . Это означает, что текущий DHCP-лизинг
будет завершен, и интерфейс потеряет свой IP-адрес, назначенный DHCP-сервером.

`sudo dhclient enp0s8`
Эта команда запускает клиент DHCP для интерфейса enp0s8 , запрашивая новый IP адрес от DHCP-сервера. Если интерфейс уже имеет IP-адрес, эта команда обновит или
перезапросит текущий адрес.

## Part 7. NAT

В файле /etc/apache2/ports.conf на ws22 и r1 измени строку Listen 80 на Listen 0.0.0.0:80, то есть сделай сервер Apache2 общедоступным.

Запусти веб-сервер Apache командой service apache2 start на ws22 и r1.

Добавь в фаервол, созданный по аналогии с фаерволом из Части 4, на r2 следующие правила:

1) Удаление правил в таблице filter - iptables -F;

2) Удаление правил в таблице "NAT" - iptables -F -t nat;

3) Отбрасывать все маршрутизируемые пакеты - iptables --policy FORWARD DROP.

Запусти файл также, как в Части 4.

Проверь соединение между ws22 и r1 командой ping.

Добавь в файл ещё одно правило:

4) Разрешить маршрутизацию всех пакетов протокола ICMP.

Запусти файл также, как в Части 4.

Проверь соединение между ws22 и r1 командой ping.

Добавь в файл ещё два правила:

5) Включи SNAT, а именно маскирование всех локальных ip из локальной сети, находящейся за r2 (по обозначениям из Части 5 - сеть 10.20.0.0).

6) Включи DNAT на 8080 порт машины r2 и добавить к веб-серверу Apache, запущенному на ws22, доступ извне сети.

Запусти файл также, как в Части 4.

Проверь соединение по TCP для SNAT: для этого с ws22 подключиться к серверу Apache на r1 командой:
`telnet [адрес] [порт]`

Проверь соединение по TCP для DNAT: для этого с r1 подключиться к серверу Apache на ws22 командой telnet (обращаться по адресу r2 и порту 8080).

## Выполнение Part 7.

Изменим в ws22 и r1 Listen 80 Listen 0.0.0.0:80 для того, чтобы наш сервер apache2 был общедоступный и старт сервера

ws22:
![alt text](<pictures/Picture 91.jpg>)

r1:
![alt text](<pictures/Picture 92.jpg>)

Добавление правил 1, 2, 3 в firewall.sh на r2:

![alt text](<pictures/Picture 93.jpg>)

Пинг между ws22 и r1 (сначала не было пинга из-за правил, потом я исправил в firewall.sh tcp ACCEPT, чтобы проверить, что без политики запреиа все норм)

![alt text](<pictures/Picture 94.jpg>)

Разрешил маршрутизацию всех пакетов протокола icmp:

![alt text](<pictures/Picture 101.jpg>)

Ping ws22 и r1:

![alt text](<pictures/Picture 100.jpg>)

Добавление правил SNAT/DNAT:

![alt text](<pictures/Picture 95.jpg>)

```
SNAT меняет частный IP-адрес узла-источника на публичный IP-адрес. Также может изменить порт источника в заголовках TCP/UDP. Обычно SNAT используется внутренними пользователями для доступа в Интернет.

В нашем случае SNAT меняет наш ip-адрес (машины, которая кидает реквест (ping)), который проходит через него (выходит из eth0), на внешний ip-адрес (10.100.0.12)
```
```
Destination NAT изменяет адрес назначения в заголовке IP-пакета. Он также может изменить порт назначения в заголовках TCP/UDP. DNAT используется, когда нам нужно перенаправить входящие пакеты с публичным адресом/портом назначения на частный IP-адрес/порт внутри нашей сети.

В нашем случае, это замена публичного ip-адреса на частный (для перемещения во внутренней сети и поиска нашего хоста). Стоит обратить внимание на -i (in-interface) eth0
```
Проверка SNAT:

ws22:
![alt text](<pictures/Picture 96.jpg>)

r1:
![alt text](<pictures/Picture 97.jpg>)

Проверка DNAT:

ws22:
![alt text](<pictures/Picture 99.jpg>)

r1:
![alt text](<pictures/Picture 98.jpg>)

## Part 8. Дополнительно. Знакомство с SSH Tunnels

Запусти на r2 фаервол с правилами из Части 7.

Запусти веб-сервер Apache на ws22 только на localhost (то есть в файле /etc/apache2/ports.conf измени строку `Listen 80` на `Listen localhost:80`).

Воспользуйся Local TCP forwarding с ws21 до ws22, чтобы получить доступ к веб-серверу на ws22 с ws21.

Воспользуйся Remote TCP forwarding c ws11 до ws22, чтобы получить доступ к веб-серверу на ws22 с ws11.

Для проверки, сработало ли подключение в обоих предыдущих пунктах, перейди во второй терминал (например, клавишами Alt + F2) и выполни команду:

`telnet 127.0.0.1 [локальный порт]`

## Выполнение Part 8.

Запуск веб-сервера Apache2 на ws22 c изменениям в порте Listen localhost:80:

![alt text](<pictures/Picture 102.jpg>)

Local TCP - ssh -L 8080:localhost:80 ileonov@10.20.0.20

Мы с машины ws21 (клиент) устанавливаем соединение(туннель) до машины ws22(сервер)(10.20.0.20) по SSH, как бы пробрасываем "от себя" соединение

![alt text](<pictures/Picture 103.jpg>)

Потом со второго терминала ALT+F2 проверим соединение с машины ws21

![alt text](<pictures/Picture 105.jpg>)

Remote TCP - ssh -R 8081:localhost:80 ileonov@10.10.0.21

![alt text](<pictures/Picture 106.jpg>)

Со второго терминала пробуем пингануться до машины ws11:

![alt text](<pictures/Picture 107.jpg>)